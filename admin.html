<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜管理者後台</title>
  <link rel="stylesheet" href="login.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body>
  <div class="center">
    <h2 id="admin-welcome">歡迎管理者！</h2>
    <div style="display: flex; flex-direction: column; gap: 1.2em; margin: 2em 0;">
      <button onclick="location.href='player_manage'">玩家／角色管理</button>
      <button onclick="location.href='skill_admin'">技能效果管理</button>
      <button onclick="location.href='https://shierusha.github.io/create-student/player_manage'">自家孩兒</button>
      <button onclick="location.href='https://shierusha.github.io/create-student/stidcard/shierusha-stu'">創角</button>
      <button onclick="window.open('https://shierusha.github.io/school-battle/students/AllStu', '_blank')">學生名冊</button>

      <button style="background:#999;" onclick="logout()">登出</button>
<button style="background:#651111;margin-top: 24px;" id="toggle-signup" disabled>載入註冊狀態中…</button>

    </div>
  </div>
<script>
  // ✅ 用你原本這組 client（不要再創第二個）
  const client = window.supabase.createClient(
    'https://wfhwhvodgikpducrhgda.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
  );

  // ===== 登出 =====
  async function logout() {
    await client.auth.signOut();
    location.href = 'login';
  }

  // ===== 管理員檢查（允許 admin / superadmin）+ 啟用開關按鈕 =====
  async function checkAdminAndInit() {
    const { data: { user } } = await client.auth.getUser();
    if (!user) return location.href = 'login';

    const { data, error } = await client
      .from('players')
      .select('username, role')
      .eq('email', user.email)
      .single();

    if (error || !data) return location.href = 'login';
if (data.role !== 'admin') return location.href = 'login';

    document.getElementById('admin-welcome').textContent = `歡迎偉大的 ${data.username} 管理者`;

    // 通過驗證後，才初始化註冊總開關
    initSignupToggle();
  }

  // ===== 註冊開關：讀取狀態 + 點擊切換 =====
  async function refreshSignupButton() {
  const btn = document.getElementById('toggle-signup');
  btn.disabled = true;
  btn.textContent = '讀取中…';

  const { data, error } = await client.rpc('get_signup_enabled');
  if (error) {
    console.error(error);
    btn.textContent = '讀取失敗（點我重試）';
    btn.disabled = false;
    // 讓使用者可以點按鈕重試
    btn.onclick = () => refreshSignupButton();
    return;
  }

  const enabled = Boolean(data);
  btn.dataset.enabled = String(enabled);
  btn.textContent = enabled ? '目前：開放註冊（點我關閉）' : '目前：關閉註冊（點我開啟）';
  btn.disabled = false;
}


  function initSignupToggle() {
    const btn = document.getElementById('toggle-signup');
    btn.addEventListener('click', async () => {
      const current = btn.dataset.enabled === 'true';
      btn.disabled = true;
      btn.textContent = '切換中…';
      const { error } = await client.rpc('set_signup_enabled', { p_enabled: !current });
      if (error) {
        console.error(error);
        alert('切換失敗：' + error.message);
      }
      await refreshSignupButton();
    });
    refreshSignupButton();
  }

  // 啟動
  checkAdminAndInit();
</script>
 <script>

async function sendGachaToken() {
  // 取得使用者 access_token
  let { data: { session }, error } = await client.auth.getSession();
  if (error || !session) {
    alert('尚未登入，請重新登入');
    return;
  }
  let token = session.access_token;

  // 這邊你可自訂傳什麼資料，這裡直接只傳 token
  let payload = {
    token: token,
    timestamp: new Date().toISOString()
  };

  // 使用 fetch 傳送到 gacha supabase 的 table
  let { error: insertError } = await fetch(`${GACHA_SUPABASE_URL}/rest/v1/gacha_tokens`, {
    method: "POST",
    headers: {
      "apikey": GACHA_SUPABASE_KEY,
      "Authorization": `Bearer ${GACHA_SUPABASE_KEY}`,
      "Content-Type": "application/json",
      "Prefer": "return=minimal"
    },
    body: JSON.stringify(payload)
  }).then(res => res.ok ? null : res.json());

  if (!insertError) {
    alert('扭蛋TOKEN已送出！（開發中）');
  } else {
    alert('送出失敗：' + JSON.stringify(insertError));
  }
}
  </script>

</body>
</html>
