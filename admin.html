<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜管理者後台</title>
  <link rel="stylesheet" href="login.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .center {
      max-width: 430px;
      margin: 60px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 24px #0002;
      padding: 32px 20px 28px 20px;
      text-align: center;
    }
    .tab-bar {
      display: flex;
      gap: 10px;
      margin: 18px 0 28px 0;
      justify-content: center;
    }
    .tab-btn {
      border: none;
      border-radius: 7px 7px 0 0;
      background: #e9e9e9;
      cursor: pointer;
      font-weight: bold;
      outline: none;
      letter-spacing: 1px;
      transition: background 0.2s, color 0.2s;
      color: #655;
      font-size: 1.06em;
    }
    .tab-btn.active {
      background: #e3d3d3;
      color: #651111;
      box-shadow: 0 2px 12px #bbb7;
      border-bottom: 2px solid #c0b1b1;
    }
    .tab-content {
      display: none;
      flex-direction: column;
      gap: 1.2em;
      margin: 2em 0 0 0;
      align-items: center;
    }
    .tab-content.active {
      display: flex;
    }
    #toggle-signup {
      background:#651111 !important;
      color: #fff !important;
      margin-top: 8px;
    }
    .logout-btn {
      background:#999 !important;
      margin-top:32px;
      color: #fff !important;
    }
  </style>
</head>
<body>
  <div class="center">
    <h2 id="admin-welcome">歡迎管理者！</h2>
    
    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="manage">管理／審核</button>
      <button class="tab-btn" data-tab="character">角色相關</button>
      <button class="tab-btn" data-tab="gacha">扭蛋相關</button>
    </div>

    <!-- Tab1: 管理/審核 -->
    <div class="tab-content active" id="tab-manage">
      <button onclick="location.href='player_manage'">玩家／角色管理</button>
      <button onclick="location.href='skill_admin'">技能效果管理</button>
      <button id="toggle-signup" disabled>載入註冊狀態中…</button>
    </div>

    <!-- Tab2: 角色相關 -->
    <div class="tab-content" id="tab-character">
                  <button onclick="location.href='https://shierusha.github.io/library/story/story'">前往休息室</button>

      <button onclick="location.href='https://shierusha.github.io/create-student/stidcard/shierusha-stu'">創角</button>
      <button onclick="location.href='https://shierusha.github.io/create-student/player_manage'">自家孩兒</button>
      <button onclick="window.open('https://shierusha.github.io/school-battle/students/AllStu', '_blank')">學生名冊</button>
      <button onclick="window.open('https://shierusha.github.io/create-student/thanks/thanks', '_blank')">感謝名冊</button>
    </div>

    <!-- Tab3: 扭蛋相關 -->
    <div class="tab-content" id="tab-gacha">
      <button id="go-gacha-btn" onclick="goGacha()">前往扭蛋</button>
      <button id="go-gacha-admin-btn" onclick="goGachaAdmin()">扭蛋管理</button>
      <!-- ★ 新增這顆：抽數管理（連到 /library/lib/gacha） -->
      <button id="go-gacha-grant-btn" onclick="goGachaGrant()">抽數管理</button>
    </div>
    
    <button class="logout-btn" onclick="logout()">登出</button>
  </div>

<script>
  // Tab 切換
  document.addEventListener('DOMContentLoaded', function () {
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(btn => {
      btn.onclick = function () {
        tabs.forEach(b => b.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      }
    });
  });
</script>

<script>
  // ========== Supabase 初始化 ==========
  const client = window.supabase.createClient(
    'https://wfhwhvodgikpducrhgda.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
  );

  // ===== 登出 =====
  async function logout() {
    await client.auth.signOut();
    localStorage.removeItem('gacha_b_jwt');
    localStorage.removeItem('gacha_b_jwt_exp');
    localStorage.removeItem('gacha_b_user');
    localStorage.removeItem('gacha_player_name');
    localStorage.removeItem('gacha_app_role');
    location.href = 'https://shierusha.github.io/login/login';
  }

  // ===== 管理員檢查（允許 admin / superadmin）+ 啟用開關按鈕 =====
  async function checkAdminAndInit() {
    const { data: { user } } = await client.auth.getUser();
    if (!user) return location.href = 'login';

    const { data, error } = await client
      .from('players')
      .select('username, role')
      .eq('email', user.email)
      .single();

    if (error || !data) return location.href = 'login';
    if (data.role !== 'admin') return location.href = 'login';

    document.getElementById('admin-welcome').textContent = `歡迎偉大的 ${data.username} 管理者`;
    initSignupToggle();
  }

  // ===== 註冊開關：讀取狀態 + 點擊切換 =====
  async function refreshSignupButton() {
    const btn = document.getElementById('toggle-signup');
    btn.disabled = true;
    btn.textContent = '讀取中…';

    const { data, error } = await client.rpc('get_signup_enabled');
    if (error) {
      console.error(error);
      btn.textContent = '讀取失敗（點我重試）';
      btn.disabled = false;
      btn.onclick = () => refreshSignupButton();
      return;
    }

    const enabled = Boolean(data);
    btn.dataset.enabled = String(enabled);
    btn.textContent = enabled ? '目前：開放註冊（點我關閉）' : '目前：關閉註冊（點我開啟）';
    btn.disabled = false;
  }

  function initSignupToggle() {
    const btn = document.getElementById('toggle-signup');
    btn.addEventListener('click', async () => {
      const current = btn.dataset.enabled === 'true';
      btn.disabled = true;
      btn.textContent = '切換中…';
      const { error } = await client.rpc('set_signup_enabled', { p_enabled: !current });
      if (error) {
        console.error(error);
        alert('切換失敗：' + error.message);
      }
      await refreshSignupButton();
    });
    refreshSignupButton();
  }

  // ===== 啟動 =====
  checkAdminAndInit();

  // ====== 扭蛋跨專案登入（共用） ======
  const EXCHANGE_URL = 'https://ogzpfrkwnqqaitytncla.supabase.co/functions/v1/exchange-token';

  async function exchangeForGachaIfNeeded() {
    // 1) A 專案 Session
    const { data: { session } } = await client.auth.getSession();
    if (!session?.access_token) { alert('請先登入'); throw new Error('no A session'); }

    // 2) 顯示名稱（username > email 前半）
    let username = '玩家';
    try {
      const { data: me } = await client
        .from('players')
        .select('username, email')
        .eq('email', session.user.email)
        .single();
      if (me?.username && me.username.trim()) {
        username = me.username.trim();
      } else if (me?.email) {
        username = String(me.email).split('@')[0] || '玩家';
      }
    } catch (_) {}

    // 3) 若已有未過期 B 簽，略過重換（留 5 分鐘緩衝）
    const now = Math.floor(Date.now() / 1000);
    const exp = Number(localStorage.getItem('gacha_b_jwt_exp') || 0);
    const hasFresh = localStorage.getItem('gacha_b_jwt') && exp && (exp - now > 300);

    if (!hasFresh) {
      const r = await fetch(EXCHANGE_URL, {
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({ token: session.access_token })
      });
      const x = await r.json();
      if (!r.ok || !x?.token) {
        console.error('exchange-token failed:', x);
        alert('交換 Token 失敗'); throw new Error('exchange failed');
      }
      localStorage.setItem('gacha_b_jwt', x.token);
      localStorage.setItem('gacha_b_jwt_exp', String(x.exp || 0));
      localStorage.setItem('gacha_b_user', x.sub || '');
      localStorage.setItem('gacha_app_role', x.role || 'PLAYER'); // 若有帶 ADMIN 會覆蓋
    }

    // 4) 不論是否重換，都更新顯示名稱
    localStorage.setItem('gacha_player_name', username);
  }

  // 原本：前往扭蛋（保留；管理員也能抽）
  async function goGacha() {
    try {
      await exchangeForGachaIfNeeded();
      location.href = 'https://shierusha.github.io/library/gacha';
    } catch (e) { /* 已 alert */ }
  }

  // 既有：扭蛋管理（卡池/活動）
  async function goGachaAdmin() {
    try {
      await exchangeForGachaIfNeeded();
      location.href = 'https://shierusha.github.io/library/lib/gachaUD';
    } catch (e) { /* 已 alert */ }
  }

  // ★ 新增：抽數管理（抽數贈送 / 舊饅頭回流）
  async function goGachaGrant() {
    try {
      await exchangeForGachaIfNeeded();
      location.href = 'https://shierusha.github.io/library/lib/gacha';
    } catch (e) { /* 已 alert */ }
  }
</script>

</body>
</html>
