
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜玩家/角色管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7fa; margin: 0; padding: 2rem; }
.container { max-width: 1200px; margin: auto; background: white; padding: 2rem; border-radius: 1.3rem; box-shadow: 0 2px 16px #0001; }
h2 { text-align: center; margin-bottom: 1.3rem; }
.tabs-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1.2em;
  margin-bottom: 1.3em;
}
.tabs { display: flex; gap: 1.2em; }
.tab { cursor: pointer; padding: 0.65em 2.2em; border-radius: 2em; background: #eef2fa; color: #1d4076; font-weight: 600; transition: background .18s;}
.tab.active { background: #1767a0; color: #fff; }
.return-btn, .delete-toggle-btn {
  background: #eef2fa;
  color: #1d4076;
  border: none;
  border-radius: 2em;
  padding: 0.65em 2.2em;
  font-weight: 600;
  font-size: 1em;
  cursor: pointer;
  transition: background .18s;
  margin-left: 0.7em;
}
.return-btn:hover, .return-btn:focus,
.delete-toggle-btn:hover, .delete-toggle-btn:focus {
  background: #1767a0;
  color: #fff;
}
.delete-toggle-btn.active {
  background: #f66464;
  color: #fff;
}
.search-row { display: flex; gap: 1em; align-items: center; margin-bottom: 1.2em; }
.search-row select, .search-row input { padding: 0.4em 1em; border-radius: 0.7em; border: 1px solid #ccc; }
.msg { min-height: 1.5em; margin-bottom: 0.8em; }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
th, td { border-bottom: 1px solid #eef2fa; padding: 0.44em 0.63em; text-align: left; }
th { background: #f4f7fa; font-size: 1em; cursor: pointer; }
.btn { background: #1767a0; color: #fff; border: none; border-radius: 0.5em; padding: 0.3em 0.8em; font-weight: 600; cursor: pointer; margin-right: 0.2em;}
/* 刪除按鈕顯示控制 START */
.btn-del { background: #f66464; display: none; }
#players-table .btn-del.show { display: inline-block; }
.role-table .btn-del.show { display: inline-block; }
/* 刪除按鈕顯示控制 END */
.btn-del[disabled] { opacity: 0.4; cursor: not-allowed; }
.expand-row { background: #f7f9fd; }
.collapse-content { padding: 1em 2em; }
.pagination { text-align: center; margin: 1em 0; }
.pagination button { margin: 0 0.25em; border: none; background: #d7e4f5; color: #1767a0; padding: 0.3em 0.7em; border-radius: 0.5em; font-weight: 600; cursor: pointer;}
.pagination button.active { background: #1767a0; color: #fff; }
@media (max-width: 950px) {
  .tabs-row { flex-direction: column; gap: 0.4em;}
  .tabs { flex-direction: column; gap: 0.4em;}
  th, td { font-size: 0.95em; }
  .return-btn, .delete-toggle-btn { margin-left: 0; margin-top: 0.5em; }
}

/* ========== 角色管理專用 CSS ========== */
.role-table-wrap { overflow-x: auto; }
.role-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1.2em;
}
.role-table th, .role-table td {
  border-bottom: 1px solid #eef2fa;
  padding: 0.44em 0.63em;
  text-align: left;
}
.role-table th {
  background: #f4f7fa;
  font-size: 1em;
  font-weight: 700;
}
.role-table .btn {
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.3em 0.9em;
  font-weight: 600;
  cursor: pointer;
  margin-right: 0.2em;
}
.role-table .btn-edit { background: #4e892a; }
.role-table .btn-link { background: #3d648d; }
.role-table .open-card-row {
  background: #f7f9fd;
}
.role-table .student-card-box {
  padding: 1em 1.5em;
  border-radius: 0.7em;
  background: #f4f7fa;
  margin: 0.8em 0;
  font-size: 1em;
}

/* Modal Dialog 通用樣式 */
.modal-bg {
  display: none;
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.22); z-index: 1001;
  justify-content: center; align-items: center;
}
.modal {
  background: #fff;
  border-radius: 1em;
  min-width: 200px;
  max-width: 80%;
  padding: 2em 1.5em;
  box-shadow: 0 4px 24px #0004;
  position: relative;
}
.modal h3 { margin-top: 0; margin-bottom: 1em; }
.modal .radio-row { margin: 0.9em 0; font-size: 1.05em; }
.modal input[type="radio"] { transform: scale(1.2); margin-right: 0.5em; }
.modal .close-btn {
  position: absolute; top: 0.6em; right: 1em;
  background: none; border: none;
  font-size: 1.6em; color: #999; cursor: pointer;
}

@media (max-width: 650px) {
  .role-table th, .role-table td { font-size: 0.96em; }
  .modal { padding: 1.2em; }
}
</style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <h2>玩家 / 角色管理後台</h2>
  <div class="tabs-row">
    <div class="tabs" id="tabs">
      <!-- JS 會自動產生分頁按鈕 -->
    </div>
    <div>
      <button id="delete-toggle-btn" class="delete-toggle-btn" type="button">啟用刪除</button>
      <button class="return-btn" type="button" onclick="location.href='admin.html'">返回管理者首頁</button>
    </div>
  </div>

  <div class="search-row">
    <select id="search-field"></select>
    <input id="search" type="text" placeholder="請輸入搜尋內容">
    <span class="msg" id="msg"></span>
  </div>

  <!-- 玩家管理分頁 -->
  <div class="table-wrap" id="players-table-wrap" style="display:none;">
    <table id="players-table">
      <thead>
        <tr>
          <th>玩家名稱</th>
          <th>信箱</th>
          <th>身份</th>
          <th>持有角色數</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="players-tbody">
        <!-- JS 動態產生 <tr><td>...</td></tr> 內容 -->
      </tbody>
    </table>
    <div class="pagination" id="players-pagination"></div>
  </div>

  <!-- 角色管理分頁 -->
  <div class="role-table-wrap" id="students-table-wrap" style="display:none;">
    <table class="role-table" id="role-table">
      <thead>
        <tr>
          <th>名字</th>
          <th>性別</th>
          <th>陣營</th>
          <th>狀態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="role-tbody">
        <!-- JS 動態產生 <tr><td>...</td></tr> 內容 -->
      </tbody>
    </table>
    <div class="pagination" id="students-pagination"></div>
  </div>
</div>

<!-- 角色管理分頁：審核彈窗 -->
<div class="modal-bg" id="review-modal-bg">
  <div class="modal">
    <button class="close-btn" type="button">×</button>
    <h3>審核狀態設定</h3>
    <div id="review-status-list">
      <!-- JS 產生 radio 狀態選單 -->
    </div>
  </div>
</div>
</body>

<script>
window.supabase = window.supabase || supabase;
window.client = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);
//角色卡ID
const TEST_STUDENT_IDS = [
  '434cbc99-9a4f-4334-bc71-7236b8daf51c', // 777
  '6ceb01f3-d296-438f-be5a-eebfa6e30e41', // 夢荔枝
  '845dd04d-ff39-43a8-ad84-e8f714a8b454', //工具寵
  'fe4e4c3e-66ae-4ded-afe6-417f73979131', //梨
  '7712a95b-7884-4e34-8dba-65ff01084b16', //咕咕
  'ee8ea0cd-d664-4b5f-8d0e-0240bf9debdb'//現荔枝
];
const SPECIAL_PLAYER_ID = '8aea3076-294c-41f6-bb38-0a99da77c098'; //其實是AI

const OCCUPATION_MAP = { attack: "攻擊手", healer: "補師", tank: "坦克", buffer: "增益手", jammer: "妨礙手" };
const GENDER_MAP = { M: "男", F: "女", O: "其他" };
const ALIGNMENT_MAP = { white: "白", black: "黑" };
const ELEMENT_MAP = { fire: "火", water: "水", ice: "冰", wind: "風", earth: "土", thunder: "雷", dark: "暗", light: "光" };
const RANGE_MAP = { same_zone: "近距離", cross_zone: "遠距離", all_zone: "遠近皆可" };
const ROLE_MAP = { melee: "近戰攻擊手", ranger: "遠攻攻擊手", balance: "普通攻擊手" };
const POSITION_MAP = { close: "近戰區", far: "遠攻區" };

function mapEnum(val, mapObj) {
  if (!val) return "";
  if (Array.isArray(val)) return val.map(v => mapObj[v] || v).join(" / ");
  return mapObj[val] || val;
}

function getStuParam() {
  const url = new URL(location.href);
  return url.searchParams.get("stu") || "";
}

function isUuid(v) {
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v);
}


function bustCache(url) {
  if (!url) return '';
  return url + (url.includes('?') ? '&v=' : '?v=') + Date.now();
}
// 查目前登入帳號在players表的role（判斷是不是admin）
async function getIsAdmin(client) {
  const { data: { user } } = await client.auth.getUser();
  const currentPlayerId = user?.id || "";
  if (!currentPlayerId) return false;
  let { data: player } = await client
    .from('players')
    .select('role')
    .eq('player_id', currentPlayerId)
    .maybeSingle();
  return player && player.role === 'admin';
}

// 查學生卡（權限全部寫死）


async function fetchStudentData(client, stuParam, isAdmin) {
if (isUuid(stuParam)) {
  let { data, error } = await client
    .from('students')
    .select('*, student_images(*), student_notes(*), player_id, element_weakness:weakness_id(element)')
    .eq('student_id', stuParam)
    .maybeSingle();
  if (error || !data) return null;

  // 只要這張卡是特殊玩家的，任何人都能查
  if (data.player_id === SPECIAL_PLAYER_ID) return data;

  // 其他卡走權限
  if (
    TEST_STUDENT_IDS.includes(data.student_id) || // 白名單
    isAdmin                                       // 管理員
  ) return data;

  return null;
}

  
  // 用 student_code 查，任何人都可
  let { data, error } = await client
    .from('students')
    .select('*, student_images(*), student_notes(*), element_weakness:weakness_id(element)')
    .eq('student_code', stuParam)
    .maybeSingle();
  if (error || !data) return null;
  return data;
}

// 查技能（這裡加入 movement_skill 資訊）
async function fetchSkills(client, student_id) {
  let { data: skills, error } = await client
    .from('student_skills')
    .select(`
      *,
      passive_trigger:passive_trigger_id(condition),
      movement_skill:linked_movement_id(move_name),
      student_skill_effect_links(effect_id, skill_id, effect:effect_id(effect_name,description)),
      student_skill_debuff_links(debuff_id, skill_id, applied_to, debuff:debuff_id(debuff_name))
    `)
    .eq('student_id', student_id)
    .order('skill_slot', { ascending: true });
  if (error || !skills) return [];
  return skills.map(s => ({
    ...s,
    effects: (s.student_skill_effect_links || []).map(e => e.effect?.effect_name).filter(Boolean),
    debuffs: (s.student_skill_debuff_links || []).map(d => ({
      applied_to: d.applied_to === "self" ? "自身" : "目標",
      name: d.debuff?.debuff_name
    })).filter(d => d.name),
    custom_skill_effect: s.custom_skill_uuid && s.custom_skill_uuid.description,
    trigger_condition: s.passive_trigger && s.passive_trigger.condition,
    movement_effect_name: s.movement_skill?.move_name   // 新增
  }));
}

// 填入資料
function fillStudentCard(student, skills) {
  const frontImg = (student.student_images || []).find(i => i.image_type === "front");
  const backImg = (student.student_images || []).find(i => i.image_type === "back") || frontImg;

    // 加 cache-busting
  document.querySelectorAll('[data-key="student_images.front_url"]').forEach(el => {
    if (frontImg) el.src = bustCache(frontImg.image_url);
  });
  document.querySelectorAll('[data-key="student_images.back_url"]').forEach(el => {
    if (backImg) el.src = bustCache(backImg.image_url);
  });

  document.querySelectorAll('[data-key="students.student_code"]').forEach(el => el.innerText = student.student_code);
  document.querySelectorAll('[data-key="students.name"]').forEach(el => el.innerText = student.name);
document.querySelectorAll('[data-key="students.nickname"]').forEach(el => {
  if (!student.nickname) {
    el.parentElement.style.display = 'none';
    el.innerText = "";
  } else {
    el.parentElement.style.display = '';   // ← 若要回復顯示
    el.innerText = student.nickname;
  }
});
  document.querySelectorAll('[data-key="students.alignment"]').forEach(el => el.innerText = mapEnum(student.alignment, ALIGNMENT_MAP));
  document.querySelectorAll('[data-key="students.race"]').forEach(el => el.innerText = student.race || "");
  document.querySelectorAll('[data-key="students.age"]').forEach(el => el.innerText = (student.age && student.age > 0) ? student.age : "？");
  document.querySelectorAll('[data-key="students.gender"]').forEach(el => el.innerText = mapEnum(student.gender, GENDER_MAP));
  document.querySelectorAll('[data-key="students.height"]').forEach(el => el.innerText = student.height || "");
  document.querySelectorAll('[data-key="students.weight"]').forEach(el => el.innerText = student.weight || "");
  document.querySelectorAll('[data-key="students.likes"]').forEach(el => el.innerText = student.likes || "");
  document.querySelectorAll('[data-key="students.hate"]').forEach(el => el.innerText = student.hate || "");
  document.querySelectorAll('[data-key="students.background"]').forEach(el => el.innerText = student.background || "");
  document.querySelectorAll('[data-key="students.occupation_type"]').forEach(el => el.innerText = mapEnum(student.occupation_type, OCCUPATION_MAP));
document.querySelectorAll('[data-key="students.element"]').forEach(el => { el.innerText = student.element ? mapEnum(student.element, ELEMENT_MAP) : "無";});
  document.querySelectorAll('[data-key="element_weakness.element"]').forEach(el => {
    el.innerText = student.element_weakness && student.element_weakness.element ? mapEnum(student.element_weakness.element, ELEMENT_MAP) : "無"; });
  document.querySelectorAll('[data-key="students.preferred_role"]').forEach(el => el.innerText = mapEnum(student.preferred_role, ROLE_MAP));
  document.querySelectorAll('[data-key="students.starting_position"]').forEach(el => { el.innerText = student.starting_position ? mapEnum(student.starting_position, POSITION_MAP) : "無";});
  document.querySelectorAll('[data-key="students.personality"]').forEach(el => el.innerText = student.personality || ""); // 新增這行

  document.querySelectorAll('[data-key="student_notes.content"]').forEach(el => {
    if (!student.student_notes || student.student_notes.length === 0) {
      el.innerText = "";
      return;
    }
    el.innerText = student.student_notes
      .sort((a, b) => a.sort_order - b.sort_order)
      .map(n => n.is_public ? `# ${n.content}` : "# ???")
      .join('\n');
  });

  for (let i = 0; i < 2; i++) {
    const skill = skills[i] || {};
    document.querySelectorAll(`[data-key="student_skills.${i + 1}.skill_name"]`).forEach(el => el.innerText = skill.skill_name || "");
    document.querySelectorAll(`[data-key="student_skills.${i + 1}.final_cd"]`).forEach(el => el.innerText = skill.is_passive ? "X" : (skill.final_cd ?? 0));
    document.querySelectorAll(`[data-key="student_skills.${i + 1}.max_targets"]`).forEach(el => {
      let val = skill.max_targets;
      if (val === 1) el.innerText = "單體";
      else if (val > 1) el.innerText = `範圍(${val})`;
      else el.innerText = "";
    });
    document.querySelectorAll(`[data-key="student_skills.${i + 1}.range"]`).forEach(el => el.innerText = mapEnum(skill.range, RANGE_MAP));
    document.querySelectorAll(`[data-key="student_skills.${i + 1}.description"]`).forEach(el => {
      if (skill.is_passive && skill.trigger_condition) {
        el.innerText = `${skill.description || ""}\n\n條件：${skill.trigger_condition}`;
      } else {
        el.innerText = skill.description || "";
      }
    });
    document.querySelectorAll(`[data-key="student_skills.${i + 1}.effectsAndDebuffs"]`).forEach(el => {
      let html = "";
      if (skill.custom_skill_effect) html += `${skill.custom_skill_effect}\n\n`;
      if (skill.effects && skill.effects.length > 0) skill.effects.forEach(e => html += `# ${e}\n`);
      if (skill.movement_effect_name) html += `# ${skill.movement_effect_name}\n`;
      if (skill.debuffs && skill.debuffs.length > 0) skill.debuffs.forEach(d => html += `# ${d.applied_to}${d.name}\n`);
      el.innerText = html;
    });
  }

  const extraSkills = skills.slice(2);
  document.querySelectorAll('[data-key="student_skills.extra_skills"]').forEach(el => {
    if (extraSkills.length === 0) {
      el.style.display = "none";
      el.onclick = null;
    } else {
      el.style.display = "";
      el.onclick = () => {
        let html = "";
        extraSkills.forEach(skill => {
          html += `${skill.skill_name || ""}\n${skill.description || ""}\n\n`;
        });
        if (typeof showInfoModal === "function")
          showInfoModal("額外技能", html.replace(/\n/g, "<br>"));
      };
    }
  });

  // ★★★ 這裡是修正重點：填完資料後才執行這兩個 function
  if (typeof fitAll === "function") fitAll();
  if (typeof checkLongTextByCharCount === "function") checkLongTextByCharCount(11);
}

// 自動流程
window.addEventListener('DOMContentLoaded', async () => {
  const stuParam = getStuParam();
  if (!stuParam || !window.client) return;

  const isAdmin = await getIsAdmin(window.client);

  const student = await fetchStudentData(window.client, stuParam, isAdmin);

  if (!student) {
    alert("? 你想找誰?");
    return;
  }

  const skills = await fetchSkills(window.client, student.student_id);

  fillStudentCard(student, skills);
});


//-----------------------------------------------------------

function setNameFontSize(selector, maxChars) {
  document.querySelectorAll(selector).forEach(box => {
    const nameDiv = box.querySelector('.name-box');
    if (!nameDiv) return;
    const fontSize = box.offsetHeight / maxChars * 0.98;
    nameDiv.style.fontSize = fontSize + "px";
  });
}

function fitAllNameBoxes() {
  setNameFontSize('.bigname-box', 12);
  setNameFontSize('.littlename-box', 9);
}

function setInfoBoxFontSize() {
  const infoBoxes = document.querySelectorAll('.info-box');
  if (!infoBoxes.length) return;
  let minHeight = Infinity;
  infoBoxes.forEach(box => {
    const h = box.offsetHeight;
    if (h < minHeight) minHeight = h;
  });
  const fontSize = minHeight * 0.62;
  infoBoxes.forEach(box => {
    box.style.fontSize = fontSize + "px";
  });
}

function setFlipBtnFontSize() {
  document.querySelectorAll('.row-flip-btn').forEach(box => {
    const btn = box.querySelector('.flip-btn');
    if (!btn) return;
    // 用高度算，讓四字不會超出（0.55可微調）
    const fontSize = Math.max(box.offsetHeight * 0.6);
    btn.style.fontSize = fontSize + "px";
  });
}

function setStudentIdFontSize() {
  document.querySelectorAll('.student-id').forEach(box => {
    // 用外層高度計算，數字可依區塊比例微調
    const fontSize = Math.max(box.offsetHeight * 0.7); // 12是最小字體
    box.style.fontSize = fontSize + "px";
  });
}

function fitAll() {
  fitAllNameBoxes();
  setInfoBoxFontSize();
  setFlipBtnFontSize();
  setStudentIdFontSize();
}

window.addEventListener('DOMContentLoaded', fitAll);
window.addEventListener('resize', fitAll);
window.addEventListener('load', fitAll);


// 更多
// 判斷 info-value 超過 11 字才顯示 ...MORE
function checkLongTextByCharCount(N = 11) {
  document.querySelectorAll('.info-box').forEach(box => {
    const value = box.querySelector('.info-value');
    const btn = box.querySelector('.show-more-btn');
    if (!value || !btn) return;
    if (value.innerText.trim().length > N) {
      btn.style.display = 'block';
      btn.onclick = function() {
        // 標題優先抓 info-label, 沒有就用 data-title (button自訂)，最後才 "效果"
        const label = this.dataset.title || box.querySelector('.info-label')?.innerText || "效果";
        showInfoModal(label, value.innerHTML);
      }
    } else {
      btn.style.display = 'none';
    }
  });
}
// 初次不要呼叫，resize 時才判斷
window.addEventListener('resize', () => checkLongTextByCharCount(11));


// 彈跳視窗相關
function showInfoModal(title, content) {
  document.getElementById('info-modal-title').innerText = title;
  document.getElementById('info-modal-body').innerHTML = content;
  document.getElementById('info-modal').style.display = 'flex';
}
// 點背景關閉彈窗
document.getElementById('info-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    e.stopPropagation();  // ★★★ 關鍵！阻止觸發 document click
    this.style.display = 'none';
  }
});


window.addEventListener('DOMContentLoaded', () => {
  const flipCard = document.getElementById('flipCard');

  // 點翻面按鈕（阻止冒泡）
  document.querySelectorAll('.flip-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      flipCard.classList.toggle('flipped');
    });
  });

  // 點畫面上非卡片、非彈窗時才翻面
  document.addEventListener('click', (e) => {
    // 判斷 info-modal 是否有顯示
    const modal = document.getElementById('info-modal');
    const isModalOpen = modal && getComputedStyle(modal).display !== 'none';
    // 如果有彈窗開著就不做任何事
    if (isModalOpen) return;
    // 點到非卡片區才翻面
    if (!e.target.closest('#flipCard')) {
      flipCard.classList.toggle('flipped');
    }
  });
});
</script>

</body>
</html>
